#{#
# This is a template for dynamically generating a Gitlab pipeline configuration for a release train and channel.
# It is meant to be used alongside the fastlane template to create dynamic pipelines for each train, according to git
# history and the .lhc configuration file.
#}{% if true %}
# This file is automatically generated. Do not edit it.
#{% endif %}

workflow:
  name: "{{ config.build.productName }} {{ config.build.platform }} {{ release.versionString }} ($TIMESTAMP)"
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"

stages:
  - build
  - publish
  - test
  - deploy
  - test_ui
  - cleanup

variables:
  PIPELINE_HOST: {{ config.build.ci.userProperties.pipelineHosts|split:","|random }}
  # Use parallel compression/decompression to speed up caching
  FF_USE_FASTZIP: "true"
  # Low-effort compression to reduce bandwidth spent uploading/downloading, with some parallelism for speed
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  # We don't care about size of the caches since they're stored locally, just the time spent to zip/unzip them
  CACHE_COMPRESSION_LEVEL: "fastest"
  # Increase the timeout for resolving build settings
  FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 300
  # Unique timestamp according to the commit and pipeline ID
  TIMESTAMP: "{% include "timestamp.base" %}"
  # Exportable configurations available for building the app
  APP_CONFIGURATIONS: {%+ block app_configurations %}{{ config.build.userProperties.appConfigurations }}{% endblock +%}
  BUILD_HOST_IDENTIFIER: "macos-{{ config.build.userProperties.platformVersion }}-xcode-{{ config.build.userProperties.toolchainVersion }}"
{% if config.distribution.sparkle %}
  SPARKLE_XML_FILE: "sparkle.xml"
  APPCAST_URL: "https://protonvpn.com/download/macos-update3.xml"
{% endif %}

default:
  image: "team-vpn-$BUILD_HOST_IDENTIFIER"

include:
  - component: gitlab.protontech.ch/proton/devops/cicd-components/kits/devsecops/generic@0.0.10
    inputs:
      allowed-to-fail: true

  - component: gitlab.protontech.ch/proton/devops/cicd-components/kubernetes/atlas-deploy/pipenv@0.7.0 {# Deploy jobs amended in test template #}
    inputs:
      cleanup-stage: cleanup
      key: atlas-$CI_COMMIT_REF_SLUG
      expiration: "2h"
      cleanup: manual

  - component: gitlab.protontech.ch/proton/devops/cicd-components/kubernetes/atlas-deploy/pipenv@0.7.0
    inputs:
      cleanup-stage: cleanup
      deploy: manual
      cleanup: manual
      images: $IMAGES
      key: custom-env-atlas-$CI_COMMIT_REF_SLUG
      suffix: ":custom"
      expiration: "2h"
      cleanup: manual

{%- if config.releaseChannel == "production" and config.build.ci.tagName -%}{# Jobs amended in publish template #}
  - project: 'agarroux/publish-github'
    ref: feat/github-app
    file: '/jobs/release.gitlab-ci.yml'
{%- endif -%}

{%- if config.distribution.sparkle -%}
{%-
    if (config.releaseChannel == "alpha" and config.build.ci.tagName) or
       config.build.ci.refName == config.userProperties.releaseBranch
-%}{# Include the Nexus release upload jobs #}
{% for configuration in block.app_configurations|split:"," %}{# Jobs amended in publish template #}
  - component: "gitlab.protontech.ch/proton/devops/cicd-components/tools/artifactlift/release-candidate@0.1.20"
    inputs:
      stage: publish
      product: vpn
      version: "{{ short_version }}+{% include "timestamp" %}{% if configuration == "Staging" %}.staging{% endif %}"
      platform: macos
      artifact_list: "ProtonVPN_mac_v{{ short_version }}.dmg {% if configuration != "Staging" %} sparkle.signature sparkle.xml {% endif %}"
      artifact_local_directory: output/mac/{{ configuration }}
      {% if configuration == "Staging" %}
      job_prefix: staging-
      {% endif %}
{% endfor %}
{% elif config.build.ci.tagName -%}{# Include the Nexus release promotion jobs #}
  - component: "gitlab.protontech.ch/proton/devops/cicd-components/tools/artifactlift/release@0.1.20"
    inputs:
      stage: publish
      product: vpn
      version: "{{ release.versionString }}"
      platform: macos
      artifact_list: "ProtonVPN_mac_v{{ short_version }}.dmg sparkle.signature sparkle.xml"
      artifact_metadata_list: "sparkle.xml"
      artifact_metadata_path: "macos/updates/v4"
      artifact_local_directory: artifacts
{% endif %}
{% endif +%}

# BUILD CACHES
##############
# Caches for DerivedData, fetched SPM packages, and Mint build dependencies
.derived_data_cache_template:
  variables: &derived_data_cache_variables
    DERIVED_DATA_PATH: .caches/Xcode/DerivedData
    DERIVED_DATA_CACHE_POLICY: pull-push
    TRAIN_CACHE_KEY: "{{ config.build.platform }}-host-$BUILD_HOST_IDENTIFIER"
  cache: &derived_data_cache_cache
    - key: build-$TRAIN_CACHE_KEY-$CI_COMMIT_REF_SLUG
      fallback_keys:
        - build-$TRAIN_CACHE_KEY-{{ config.userProperties.releaseBranch }}
        - build-$TRAIN_CACHE_KEY-$CI_DEFAULT_BRANCH
      paths:
        - $DERIVED_DATA_PATH
      policy: $DERIVED_DATA_CACHE_POLICY

.mint_cache_template:
  variables: &mint_cache_variables
    MINT_PATH: $CI_PROJECT_DIR/.caches/mint
    MINT_LINK_PATH: $MINT_PATH/bin
    MINT_CACHE_POLICY: pull-push
  cache: &mint_cache_cache
    - key: mint-$CI_COMMIT_REF_SLUG
      fallback_keys:
        - mint-{{ config.userProperties.releaseBranch }}
      paths:
        - $MINT_CACHE_PATH
      policy: $MINT_CACHE_POLICY

.build_cache_template:
  variables:
    <<: *derived_data_cache_variables
    <<: *mint_cache_variables
  cache:
    - *derived_data_cache_cache
    - *mint_cache_cache

# JOB TEMPLATE
##############
# All jobs in this file extend this template.
.job_template:
  variables:
    # Tart mounts the host volume at /Volumes/My Shared Files, which breaks both Mint and GNU Make thanks to the space
    # in the filename. We create a symlink to our builddir so they can continue pretending that spaces don't exist.
    ARTIFACTS_DIR: "{{ config.build.outputDirectory }}/$CONFIGURATION"
  before_script:
    - ./Integration/Scripts/pipeline_setup.sh
  after_script: |
    # Delete all ssh private keys
    ssh-add -D
  interruptible: true

# BUILD STEP
############
# Creates app artifacts for shipping, and test bundles for running tests.
{% if channel == "alpha" or config.build.ci.eventType == "merge_request_event" %}
{% include "gitlab-build-job.yml" %}
{% endif %}

# PUBLISH STEP
##############
# Sends app binaries to the correct place, according to the release channel.
{%
  if (channel == "alpha" and config.build.ci.tagName) or
    config.build.ci.refName == config.userProperties.releaseBranch
%}
{% include "gitlab-publish-jobs.yml" %}
{% endif %}

# TEST STEP
###########
# Runs unit and partial/full UI tests depending on the context.
{% if channel == "alpha" or config.build.ci.eventType == "merge_request_event" %}
{% include "gitlab-test-jobs.yml" %}
{% endif %}

# ANNOUNCE STEP
##############
# Runs jobs announcing new builds and/or pipeline failures.
{% include "gitlab-announce-jobs.yml" %}
