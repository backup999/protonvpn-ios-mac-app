{% extends "gitlab-test-job.base.yml" %} {# Default test template #}

{% block test_job_name %}.test_job_template{% endblock %}
{% block testplan_name %}{{ config.build.productName }}-{{ config.build.platform }}-$TEST_SUITE{% endblock %}

{% block test_tags %}
    - vpn-{{ config.build.platform|lowercase }}-tests
    - $PIPELINE_HOST
{% endblock %}

{% block test_vars %}
{{ block.super }}
    GIT_DEPTH: 1
    GIT_SUBMODULE_STRATEGY: none
    DERIVED_DATA_CACHE_POLICY: pull
    MINT_CACHE_POLICY: pull
    TEST_SUITE: Unit-All
{% endblock %}

{% block test_header %}
  extends:
    - .job_template
    - .build_cache_template
{% endblock %}

{#
 # For merge results, all tests are manual.
 # Merge requests run unit and UI smoke tests.
 # Scheduled/web pipelines run unit and full UI tests.
 #}
{% block test_rules %}
{% if config.build.ci.eventType == "merge_request_event" and config.build.ci.refName != config.userProperties.releaseBranch %}
    - if: $TEST_SUITE == "UI-All"
      when: manual
      allow_failure: true
    - when: on_success
{% elif config.build.ci.eventType == "schedule" or config.build.ci.eventType == "web" %}
    - if: $TEST_SUITE == "UI-Smoke"
      when: manual
      allow_failure: true
    - when: on_success
{% else %}
    - when: manual
      allow_failure: true
{% endif %}
{% endblock %}

{% block test_footer %}

.ui_test_template:
  extends:
    - .test_job_template
  stage: test_ui
  needs:
    - !reference [.test_job_template, needs]
    - job: 'deploy:review' # Make sure env gets deployed before starting UI tests

# Unit tests run automatically on every job, provided the upstream pipelines (e.g. builds) are run.
test:{{ config.name }}:unit:
  extends:
    - .test_job_template
  stage: test
  variables:
    TEST_SUITE: Unit-All

# Smoke UI tests run for all merge request events, including merged results.
test:{{ config.name }}:ui:smoke:
  stage: test_ui
  variables:
    TEST_SUITE: UI-Smoke
  extends:
    - .ui_test_template
  rules:
{% if config.build.ci.eventType == "merge_request_event" %}
    - when: on_success
{% else %}
    - when: manual
      allow_failure: true
{% endif %}

# UI tests run automatically on scheduled pipelines only.
test:{{ config.name }}:ui:all:
  stage: test_ui
  variables:
    TEST_SUITE: UI-All
  extends:
    - .ui_test_template
  {% if config.build.ci.eventType != "schedule" %}
  when: manual
  {% endif %}

{% endblock %}
